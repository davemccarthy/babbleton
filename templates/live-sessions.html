{% extends 'base.html' %}
{% load duration_filters %}

{% block title %}Live Sessions - {{ block.super }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'live-sessions' %}">Live</a></li>
<li class="breadcrumb-item active">Sessions</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock"></i>
                    Sessions (<span id="sessions-count">{{ sessions|length }}</span>)
                </h5>
                <small class="text-muted">Auto-refreshing every 2 seconds</small>
            </div>
            <div class="card-body">
                {% if sessions %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Agent</th>
                                    <th>Start</th>
                                    <th>Duration</th>
                                    <th>Language</th>
                                    <th>Calls</th>
                                    <th>Minutes</th>
                                </tr>
                            </thead>
                            <tbody id="sessions-tbody">
                                {% for session in sessions %}
                                    <tr {% if session.external|is_external %}style="background-color: #cfe2ff !important;"{% endif %}>
                                        <td>{{ session.id }}</td>
                                        <td>{{ session.agent_name }}</td>
                                        <td>{{ session.start|date:"Y-m-d H:i:s" }}</td>
                                        <td>{{ session.duration_seconds|format_duration }}</td>
                                        <td>{{ session.language_name }}</td>
                                        <td>{{ session.calltotal|default:"0" }}</td>
                                        <td>{{ session.callduration|to_minutes }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="text-muted mt-3">No Active Sessions</h4>
                        <p class="text-muted">There are currently no active sessions to display.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Function to format duration from seconds
function formatDuration(seconds) {
    if (!seconds || seconds <= 0) return '-';
    
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    
    if (minutes > 0) {
        return `${minutes}m ${remainingSeconds}s`;
    } else {
        return `${remainingSeconds}s`;
    }
}

// Function to convert seconds to minutes
function secondsToMinutes(seconds) {
    if (!seconds || seconds <= 0) return 0;
    return Math.floor(seconds / 60);
}

// Function to check if session is external
function isExternal(value) {
    if (value === null || value === undefined) return false;
    if (typeof value === 'boolean') return value;
    if (typeof value === 'string') {
        return value.toLowerCase() in ['true', 't', '1', 'yes', 'y'];
    }
    if (typeof value === 'number') return value === 1;
    return false;
}

// Function to update the sessions table
function updateSessionsTable() {
    fetch('{% url "live-sessions-data" %}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error fetching sessions:', data.error);
                return;
            }
            
            const tbody = document.getElementById('sessions-tbody');
            const countSpan = document.getElementById('sessions-count');
            
            // Update count
            countSpan.textContent = data.count;
            
            // Clear existing rows
            tbody.innerHTML = '';
            
            // Add new rows
            data.sessions.forEach(session => {
                const row = document.createElement('tr');
                
                // Add external highlighting if needed
                if (isExternal(session.external)) {
                    row.style.backgroundColor = '#cfe2ff';
                }
                
                row.innerHTML = `
                    <td>${session.id}</td>
                    <td>${session.agent_name}</td>
                    <td>${session.start}</td>
                    <td>${formatDuration(session.duration_seconds)}</td>
                    <td>${session.language_name}</td>
                    <td>${session.calltotal}</td>
                    <td>${secondsToMinutes(session.callduration)}</td>
                `;
                
                tbody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error updating sessions:', error);
        });
}

// Auto-refresh every 2 seconds
setInterval(updateSessionsTable, 2000);

// Initial update after page load
document.addEventListener('DOMContentLoaded', function() {
    // First update after 1 second to ensure page is fully loaded
    setTimeout(updateSessionsTable, 1000);
});
</script>
{% endblock %}





